<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TiggerSmart Controller</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
            padding-bottom: 100px; /* Extra space for debug button */
        }
        
        .container { max-width: 500px; margin: 0 auto; }
        
        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { font-size: 32px; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header .subtitle { font-size: 14px; opacity: 0.9; }
        
        /* CARDS */
        .card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        /* STATUS CARD */
        .status-card { text-align: center; padding: 30px; }
        .status-icon { font-size: 60px; margin-bottom: 15px; display: block;}
        .status-text { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .status-sub { font-size: 14px; opacity: 0.8; }

        /* BATTERY GRID */
        .battery-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .battery-box { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; text-align: center; }
        .battery-box .icon { font-size: 28px; margin-bottom: 8px; }
        .battery-box .label { font-size: 11px; opacity: 0.8; }
        .battery-box .value { font-size: 28px; font-weight: 700; }
        
        .battery-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .battery-fill { height: 100%; background: #10b981; transition: width 0.5s ease; }
        .battery-fill.low { background: #ef4444; }
        .battery-fill.medium { background: #f59e0b; }

        /* CONTROLS */
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .preset-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 15px 10px; border-radius: 12px;
            font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .preset-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.3); }

        .custom-input {
            width: 100%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 12px 15px; border-radius: 12px; font-size: 14px; margin-bottom: 10px;
        }
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 15px;
            font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-debug { background: rgba(0,0,0,0.2); color: #ccc; font-size: 12px; padding: 10px; }

        /* ANIMATIONS */
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .pulsing { animation: pulse 1.5s infinite; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; display: inline-block; }

        /* DEBUG SECTION */
        #debugSection {
            display: none; /* Hidden by default */
            margin-top: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            padding: 10px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .log-container {
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #ddd;
        }
        .log-item { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .log-error { color: #ff6b6b; font-weight: bold; }
        .log-success { color: #51cf66; }
        .log-info { color: #74c0fc; }

        /* STATES */
        .state-connected { color: #10b981; }
        .state-disconnected { color: #ef4444; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí® TiggerSmart</h1>
            <div class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</div>
        </div>
        
        <div class="card status-card">
            <div id="iconArea" class="status-icon">üì°</div>
            <div id="statusTitle" class="status-text">Ready to Connect</div>
            <div id="statusSub" class="status-sub">Press the button below to start</div>
        </div>
        
        <div id="batteryCard" class="card hidden">
            <div class="battery-grid">
                <div class="battery-box">
                    <div class="icon">üîã</div>
                    <div class="label">Smoke Machine</div>
                    <div class="value" id="masterBat">--</div>
                    <div class="battery-bar"><div class="battery-fill" id="masterFill" style="width:0%"></div></div>
                </div>
                <div class="battery-box">
                    <div class="icon">üéÆ</div>
                    <div class="label">Remote</div>
                    <div class="value" id="childBat">--</div>
                    <div class="battery-bar"><div class="battery-fill" id="childFill" style="width:0%"></div></div>
                </div>
            </div>
        </div>
        
        <div id="controlCard" class="card hidden">
            <div class="preset-grid">
                <button class="preset-btn" onclick="sendCmd('off 2 on 3 done 5')">üí® Short<br><small>2s Wait / 3s Smoke</small></button>
                <button class="preset-btn" onclick="sendCmd('off 5 on 5 done 10')">üí®üí® Normal<br><small>5s Wait / 5s Smoke</small></button>
                <button class="preset-btn" onclick="sendCmd('off 3 on 7 done 10')">üí®üí®üí® Long<br><small>3s Wait / 7s Smoke</small></button>
                <button class="preset-btn" onclick="sendCmd('off 2 on 3 off 2 on 3 done 10')">üí® Double<br><small>2x Burst</small></button>
            </div>
            <input type="text" class="custom-input" id="customCmd" placeholder="Custom Command...">
            <button class="btn btn-success" onclick="sendCustom()">Send Command</button>
        </div>
        
        <button id="mainBtn" class="btn btn-primary" onclick="handleMainButton()">
            üîç Connect TiggerSmart
        </button>

        <button class="btn btn-debug" onclick="toggleDebug()">
            üõ†Ô∏è Show/Hide Debug Tools
        </button>

        <div id="debugSection" class="debug-section">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <small>System Logs</small>
                <button onclick="clearLogs()" style="background:none; border:none; color:#999; cursor:pointer;">Clear</button>
            </div>
            <div class="log-container" id="logBox"></div>
        </div>
    </div>

    <script>
        // CONFIG
        const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const CHAR_WRITE   = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
        const CHAR_NOTIFY  = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

        let isAppMode = false;
        let isConnected = false;
        let webDevice, webServer, webWriteChar;

        // UI ELEMENTS
        const ui = {
            icon: document.getElementById('iconArea'),
            title: document.getElementById('statusTitle'),
            sub: document.getElementById('statusSub'),
            btn: document.getElementById('mainBtn'),
            batCard: document.getElementById('batteryCard'),
            ctrlCard: document.getElementById('controlCard'),
            logs: document.getElementById('logBox'),
            debugSec: document.getElementById('debugSection')
        };

        // INIT
        window.addEventListener('load', () => {
            if (window.FlutterBridge) {
                isAppMode = true;
                addLog("üì± System Mode: APP (Flutter Bridge Active)", false, true);
            } else {
                addLog("üíª System Mode: WEB (Browser Bluetooth)", false, true);
            }
        });

        // TOGGLE DEBUG UI
        function toggleDebug() {
            if (ui.debugSec.style.display === 'block') {
                ui.debugSec.style.display = 'none';
            } else {
                ui.debugSec.style.display = 'block';
            }
        }

        function clearLogs() {
            ui.logs.innerHTML = '';
        }

        // MAIN BUTTON LOGIC
        function handleMainButton() {
            if (isConnected) {
                // DISCONNECT
                if (isAppMode) sendToApp('DISCONNECT');
                else disconnectWeb();
            } else {
                // CONNECT
                if (isAppMode) sendToApp('CONNECT');
                else connectWeb();
            }
        }

        // APP COMMUNICATION
        function sendToApp(action, payload = {}) {
            if (window.FlutterBridge) {
                window.FlutterBridge.postMessage(JSON.stringify({ action, payload }));
            }
        }

        // WEB BLUETOOTH LOGIC (Laptop Support)
        async function connectWeb() {
            if (!navigator.bluetooth) return alert("Web Bluetooth not supported.");
            
            try {
                handleStatus('SCANNING');
                addLog('Starting Web Bluetooth Scan...');
                
                webDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'TiggerSmart' }],
                    optionalServices: [SERVICE_UUID]
                });

                handleStatus('CONNECTING...');
                addLog(`Device Selected: ${webDevice.name}`);
                
                webDevice.addEventListener('gattserverdisconnected', () => handleStatus('DISCONNECTED'));
                
                webServer = await webDevice.gatt.connect();
                const service = await webServer.getPrimaryService(SERVICE_UUID);
                webWriteChar = await service.getCharacteristic(CHAR_WRITE);
                const notifyChar = await service.getCharacteristic(CHAR_NOTIFY);
                
                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', (e) => {
                    const val = new TextDecoder().decode(e.target.value);
                    handleData(val);
                });
                
                handleStatus('CONNECTED');
                addLog('Web Bluetooth Connected Successfully', false, true);

            } catch (e) {
                handleStatus('DISCONNECTED');
                addLog(`Web Connect Error: ${e.message}`, true);
            }
        }

        function disconnectWeb() {
            if (webDevice && webDevice.gatt.connected) webDevice.gatt.disconnect();
        }

        // COMMAND SENDER
        function sendCmd(cmd) {
            if (!isConnected) return;
            
            addLog(`üì§ Sending Command: ${cmd}`, false, false);
            if (isAppMode) {
                sendToApp('WRITE', { data: cmd });
            } else if (webWriteChar) {
                const encoder = new TextEncoder();
                webWriteChar.writeValue(encoder.encode(cmd))
                    .catch(e => addLog(`Web Write Failed: ${e}`, true));
            }
        }

        function sendCustom() {
            const el = document.getElementById('customCmd');
            if(el.value) { sendCmd(el.value); el.value = ''; }
        }

        // INCOMING DATA HANDLER
        function receiveDataFromApp(jsonStr) {
            try {
                const data = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
                
                switch(data.type) {
                    case 'STATUS': handleStatus(data.content); break;
                    case 'NOTIFICATION': handleData(data.content); break;
                    case 'ERROR': addLog(`‚ùå APP ERROR: ${data.content}`, true); break;
                }
            } catch(e) {
                addLog(`JSON Parse Error: ${e.message}`, true);
            }
        }

        // STATUS & UI UPDATE
        function handleStatus(status) {
            addLog(`‚ö° Status Update: ${status}`);
            
            if (status === 'SCANNING') {
                ui.icon.textContent = 'üîç';
                ui.icon.className = 'status-icon pulsing';
                ui.title.textContent = 'Searching...';
                ui.sub.textContent = 'Scanning for TiggerSmart...';
                ui.btn.disabled = true;
                ui.btn.textContent = 'Scanning...';
            } 
            else if (status === 'CONNECTING...') {
                ui.icon.textContent = '‚è≥';
                ui.icon.className = 'status-icon spinning';
                ui.title.textContent = 'Connecting...';
                ui.sub.textContent = 'Establishing secure link...';
            }
            else if (status === 'CONNECTED') {
                isConnected = true;
                ui.icon.textContent = '‚úÖ';
                ui.icon.className = 'status-icon';
                ui.title.textContent = 'Connected';
                ui.title.className = 'status-text state-connected';
                ui.sub.textContent = 'System Ready';
                
                ui.batCard.classList.remove('hidden');
                ui.ctrlCard.classList.remove('hidden');
                
                ui.btn.disabled = false;
                ui.btn.className = 'btn btn-danger';
                ui.btn.textContent = '‚ùå Disconnect';
            } 
            else if (status === 'DISCONNECTED') {
                isConnected = false;
                ui.icon.textContent = 'üì°';
                ui.icon.className = 'status-icon';
                ui.title.textContent = 'Disconnected';
                ui.title.className = 'status-text state-disconnected';
                ui.sub.textContent = 'Press Connect to start';
                
                ui.batCard.classList.add('hidden');
                ui.ctrlCard.classList.add('hidden');
                
                ui.btn.disabled = false;
                ui.btn.className = 'btn btn-primary';
                ui.btn.textContent = 'üîç Connect TiggerSmart';
            }
        }

        // DATA PARSER
        function handleData(str) {
            addLog(`üì• RX: ${str}`, false, true);
            
            const master = str.match(/Smoke\(MASTER\):\s*(\d+)%/);
            const child = str.match(/Remote\(CHILD\):\s*(\d+)%/);
            
            if (master) updateBat('master', master[1]);
            if (child) updateBat('child', child[1]);
        }

        function updateBat(type, val) {
            const elVal = document.getElementById(`${type}Bat`);
            const elFill = document.getElementById(`${type}Fill`);
            
            elVal.textContent = val + '%';
            elFill.style.width = val + '%';
            
            elFill.className = 'battery-fill';
            if(val < 20) elFill.classList.add('low');
            else if(val < 50) elFill.classList.add('medium');
        }

        // LOGGER
        function addLog(msg, isError = false, isSuccess = false) {
            const div = document.createElement('div');
            div.className = 'log-item';
            if(isError) div.classList.add('log-error');
            if(isSuccess) div.classList.add('log-success');
            
            const time = new Date().toLocaleTimeString('th-TH').split(' ')[0];
            div.textContent = `[${time}] ${msg}`;
            
            ui.logs.prepend(div);
        }
    </script>
</body>
</html>