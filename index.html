<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TiggerSmart Controller</title>
    <style>
        /* ... [KEEP YOUR EXISTING CSS EXACTLY AS IT IS] ... */
        /* ADD THIS FOR THE MODE SWITCHER */
        .debug-bar {
            margin-top: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            font-size: 10px;
            text-align: center;
        }
        .mode-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 5px;
        }
        .mode-web { background: #3b82f6; }
        .mode-app { background: #f59e0b; color: black; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí® TiggerSmart</h1>
            <div class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</div>
        </div>
        
        <div class="alert" id="errorAlert">
            ‚ö†Ô∏è <span id="errorText"></span>
        </div>
        
        <div class="card status-card">
            <div class="status-icon" id="statusIcon">üì°</div>
            <div class="status-text" id="statusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
            <div class="device-name" id="deviceName"></div>
        </div>

        <div class="card">
            <div class="battery-grid">
                <div class="battery-box">
                    <div class="icon">üîã</div>
                    <div class="label">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏±‡∏ô</div>
                    <div class="value" id="masterBattery">--</div>
                    <div class="battery-bar">
                        <div class="battery-fill" id="masterBatteryFill" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="battery-box">
                    <div class="icon">üéÆ</div>
                    <div class="label">‡∏£‡∏µ‡πÇ‡∏°‡∏ó‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ó‡∏£‡∏•</div>
                    <div class="value" id="childBattery">--</div>
                    <div class="battery-bar">
                        <div class="battery-fill" id="childBatteryFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card control-card">
            <h3>‚ö° ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</h3>
            <div class="preset-grid">
                <button class="preset-btn" onclick="sendPreset('off 2 on 3 done 5')">üí® ‡∏™‡∏±‡πâ‡∏ô<br><small>‡∏£‡∏≠ 2s ‚Üí ‡∏Ñ‡∏ß‡∏±‡∏ô 3s</small></button>
                <button class="preset-btn" onclick="sendPreset('off 5 on 5 done 10')">üí®üí® ‡∏õ‡∏Å‡∏ï‡∏¥<br><small>‡∏£‡∏≠ 5s ‚Üí ‡∏Ñ‡∏ß‡∏±‡∏ô 5s</small></button>
                <button class="preset-btn" onclick="sendPreset('off 3 on 7 done 10')">üí®üí®üí® ‡∏¢‡∏≤‡∏ß<br><small>‡∏£‡∏≠ 3s ‚Üí ‡∏Ñ‡∏ß‡∏±‡∏ô 7s</small></button>
                <button class="preset-btn" onclick="sendPreset('off 2 on 3 off 2 on 3 done 10')">üí®üí®üí®üí® 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á<br><small>‡∏Ñ‡∏ß‡∏±‡∏ô 3s √ó 2</small></button>
            </div>
            
            <input type="text" class="custom-input" id="customCommand" placeholder="‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á" onkeypress="if(event.key==='Enter') sendCustom()">
            <button class="btn btn-success" onclick="sendCustom()">üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</button>
        </div>
        
        <button class="btn btn-primary" id="connectBtn" onclick="connect()">üîç ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ TiggerSmart</button>
        <button class="btn btn-danger" id="disconnectBtn" onclick="disconnect()" style="display:none;">‚ùå ‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        
        <div class="card">
            <div class="log-container" id="logContainer"></div>
        </div>

        <div class="debug-bar">
            Mode: <span id="modeBadge" class="mode-badge mode-web">WEB</span>
            <button onclick="toggleMode()" style="margin-left:10px; padding:2px 5px; color:black;">Switch Mode</button>
        </div>
    </div>

    <script>
        // === CONFIGURATION ===
        const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const TX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
        const RX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
        
        // === STATE ===
        let isAppMode = false; // False = Web Bluetooth, True = Flutter Bridge
        let webDevice = null;
        let webServer = null;
        let webTxChar = null;

        // === INITIALIZATION ===
        window.addEventListener('load', () => {
            // Auto-detect Flutter
            if (window.FlutterBridge) {
                setMode(true);
            } else {
                setMode(false);
            }
        });

        function setMode(isApp) {
            isAppMode = isApp;
            const badge = document.getElementById('modeBadge');
            if (isApp) {
                badge.textContent = "APP (Flutter)";
                badge.className = "mode-badge mode-app";
                addLog("üì± App Mode Detected");
            } else {
                badge.textContent = "WEB (Chrome)";
                badge.className = "mode-badge mode-web";
                addLog("üåê Web Mode Active");
            }
        }

        function toggleMode() {
            setMode(!isAppMode);
        }

        // === CORE FUNCTIONS ===

        function connect() {
            if (isAppMode) {
                // APP MODE: Send message to Flutter
                addLog("üì° Requesting App to Scan...");
                updateUI('searching');
                sendToFlutter('CONNECT', {}); 
            } else {
                // WEB MODE: Use existing logic
                connectWebBluetooth();
            }
        }

        function disconnect() {
            if (isAppMode) {
                sendToFlutter('DISCONNECT', {});
                updateUI('idle'); // Assume success immediately for UI
            } else {
                disconnectWebBluetooth();
            }
        }

        function sendCommand(cmd) {
            if (isAppMode) {
                sendToFlutter('WRITE', { data: cmd });
                addLog(`üì§ App Sent: ${cmd}`);
            } else {
                sendWebCommand(cmd);
            }
        }

        // === FLUTTER BRIDGE COMMUNICATION ===

        // 1. OUTBOUND: Send to Flutter
        function sendToFlutter(action, payload) {
            if (window.FlutterBridge) {
                window.FlutterBridge.postMessage(JSON.stringify({
                    action: action,
                    payload: payload
                }));
            } else {
                addLog("‚ùå FlutterBridge not found!", true);
            }
        }

        // 2. INBOUND: Received from Flutter
        // This function is called BY the Flutter app code
        function receiveDataFromApp(jsonString) {
            try {
                const data = JSON.parse(jsonString);
                
                switch (data.type) {
                    case 'STATUS':
                        if (data.content === 'CONNECTED') {
                            updateUI('connected', 'TiggerSmart (App)');
                            addLog("‚úÖ App Connected via BLE");
                        } else if (data.content === 'DISCONNECTED') {
                            updateUI('disconnected');
                            addLog("‚ùå App Disconnected");
                        }
                        break;
                        
                    case 'NOTIFICATION':
                        // data.content should be the string received from ESP32
                        processNotificationData(data.content);
                        break;

                    case 'ERROR':
                        showError(data.content);
                        updateUI('idle');
                        break;
                }
            } catch (e) {
                addLog("‚ùå Parse Error: " + e, true);
            }
        }

        // === SHARED LOGIC ===
        
        function processNotificationData(valueStr) {
            addLog(`üì• RX: ${valueStr}`);
            
            if (valueStr.includes('Smoke(MASTER)')) {
                const masterMatch = valueStr.match(/Smoke\(MASTER\):\s*(\d+)%/);
                const childMatch = valueStr.match(/Remote\(CHILD\):\s*(\d+)%/);
                
                if (masterMatch) updateBattery('masterBattery', parseInt(masterMatch[1]));
                if (childMatch) updateBattery('childBattery', parseInt(childMatch[1]));
            }
        }

        // === OLD WEB BLUETOOTH LOGIC (Refactored slightly) ===

        async function connectWebBluetooth() {
            if (!navigator.bluetooth) return showError('Web Bluetooth not supported');
            try {
                updateUI('searching');
                webDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'TiggerSmart' }],
                    optionalServices: [SERVICE_UUID]
                });
                webDevice.addEventListener('gattserverdisconnected', onWebDisconnected);
                webServer = await webDevice.gatt.connect();
                const service = await webServer.getPrimaryService(SERVICE_UUID);
                webTxChar = await service.getCharacteristic(TX_CHAR_UUID);
                const rxChar = await service.getCharacteristic(RX_CHAR_UUID);
                await rxChar.startNotifications();
                rxChar.addEventListener('characteristicvaluechanged', (e) => {
                    const val = new TextDecoder().decode(e.target.value);
                    processNotificationData(val);
                });
                updateUI('connected', webDevice.name);
            } catch (error) {
                showError(error.message);
                updateUI('idle');
            }
        }

        async function sendWebCommand(cmd) {
            if (!webTxChar) return showError('Not connected');
            try {
                const encoder = new TextEncoder();
                await webTxChar.writeValue(encoder.encode(cmd));
                addLog(`üì§ Web Sent: ${cmd}`);
            } catch (e) { showError(e.message); }
        }

        function disconnectWebBluetooth() {
            if (webDevice && webDevice.gatt.connected) webDevice.gatt.disconnect();
        }

        function onWebDisconnected() {
            updateUI('disconnected');
            webDevice = null;
        }

        // === HELPER UI FUNCTIONS (Kept from your code) ===
        function updateBattery(id, percent) {
            const valueEl = document.getElementById(id);
            const fillEl = document.getElementById(id + 'Fill');
            valueEl.textContent = `${percent}%`;
            fillEl.style.width = `${percent}%`;
            fillEl.className = 'battery-fill';
            if (percent <= 20) fillEl.classList.add('low');
            else if (percent <= 50) fillEl.classList.add('medium');
        }

        function sendPreset(cmd) { sendCommand(cmd); }
        function sendCustom() { 
            const input = document.getElementById('customCommand');
            if(input.value.trim()) { sendCommand(input.value.trim()); input.value=''; }
        }

        function updateUI(status, deviceNameText = '') {
            // ... [Reuse your existing updateUI code here] ...
            // For brevity, I am not repasting the exact same long function 
            // but ensure you include the full updateUI logic from your original code here.
            
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const deviceName = document.getElementById('deviceName');

            statusIcon.className = 'status-icon';
            if(status === 'connected') {
                statusText.innerText = "Connected";
                statusIcon.innerText = "‚úÖ";
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                deviceName.innerText = deviceNameText;
            } else if (status === 'searching') {
                statusText.innerText = "Searching...";
                statusIcon.innerText = "üîç";
                statusIcon.classList.add('pulse');
            } else {
                statusText.innerText = "Disconnected";
                statusIcon.innerText = "üì°";
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                connectBtn.disabled = false;
            }
        }

        function addLog(msg, isErr=false) {
            const log = document.getElementById('logContainer');
            const item = document.createElement('div');
            item.className = 'log-item';
            item.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(isErr) item.style.borderLeftColor = 'red';
            log.prepend(item);
        }

        function showError(msg) {
            document.getElementById('errorText').innerText = msg;
            document.getElementById('errorAlert').classList.add('show');
            setTimeout(() => document.getElementById('errorAlert').classList.remove('show'), 3000);
        }
    </script>
</body>
</html>